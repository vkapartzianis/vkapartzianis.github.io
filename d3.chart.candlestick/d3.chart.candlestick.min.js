/*! d3.chart.candlestick - v0.0.3
 *  License: MIT Expat
 *  Date: 2013-08-21
 */
d3.chart("BaseCandlestickChart",{timestamp:function(a){return new Date(a).getTime()/1e3},widthForCandle:function(a){var b=(this.width()-this.margin.right)/a-2*this.strokeWidth-this.candleMargin;return b},heightForCandle:function(a,b){var c=a(Math.min(Number(b.open),Number(b.close)))-a(Math.max(Number(b.open),Number(b.close)));return 0>c?0:c},getStartingY:function(a){return Math.max(Number(a.open),Number(a.close))},initialize:function(a){a=a||{},this.exchange=a.exchange||"",this.lines=a.lines||[];var b=this;this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.base.attr("class","candlestick chart"),this.addGrid(b),this.addWicks(b),this.addOpenLines(b),this.addBars(b),this.addLastTrade(b),this.addLines(b,this.lines),this.addInfo(b),this.width(a.width||900),this.height(a.height||300),this.strokeWidth=a.strokeWidth||1,this.candleMargin=1,this.margin={top:0,bottom:0,left:0,right:60}},width:function(a){return arguments.length?(this.w=a,this.x.range([0,this.w]),this.base.attr("width",this.w),this):this.w},height:function(a){return arguments.length?(this.h=a,this.y.rangeRound([0,this.h]),this.base.attr("height",this.h),this):this.h},transform:function(a){var b;b=this.extractData(a);var c=d3.min(b.map(function(a){return new Date(a.open_time).getTime()/1e3})),d=d3.max(b.map(function(a){return new Date(a.open_time).getTime()/1e3})),e=d3.min(b.map(function(a){return Number(a.low)})),f=d3.max(b.map(function(a){return Number(a.high)})),g=.4*(f-e);return this.x.domain([c,d]).range([0,this.width()-this.margin.right]),this.y.domain([e-g,f+g]).range([this.height(),0]),b},extractData:function(a){var b;return b=a.data,this.lines.forEach(function(c){a[c]&&b.forEach(function(b,d){a[c][d]&&(b[c]=a[c][d].price)})}),b},addGrid:function(a){this.addGridY(a),this.addGridYLabels(a)},addGridY:function(a){function b(){this.attr("class","grid grid-y").attr("x1",0).attr("x2",a.width()-a.margin.right).attr("y1",a.y).attr("y2",a.y).attr("stroke-width",1)}function c(){this.duration(1e3).attr("y1",a.y).attr("y2",a.y)}function d(){this.duration(1e3).remove()}this.layer("grid-y",this.base.append("g"),{dataBind:function(){return this.selectAll("line.grid.grid-y").data(a.y.ticks(5))},insert:function(){return this.insert("line")}}),this.layer("grid-y").on("enter",b),this.layer("grid-y").on("update:transition",c),this.layer("grid-y").on("exit:transition",d)},addGridYLabels:function(a){function b(){this.attr("class","yLabel").attr("x",a.width()-a.margin.right).attr("y",a.y).attr("dy",5).attr("dx",20).attr("text-anchor","left").text(function(a){return String(a.toFixed(1))})}function c(){this.text(function(a){return String(a.toFixed(1))})}function d(){this.duration(1e3).attr("x",a.width()-a.margin.right).attr("y",a.y).attr("dy",5).attr("dx",20)}function e(){this.duration(1e3).remove()}this.layer("grid-y-labels",this.base.append("g"),{dataBind:function(){return this.selectAll("text.yLabel").data(a.y.ticks(5))},insert:function(){return this.insert("text")}}),this.layer("grid-y-labels").on("enter",b),this.layer("grid-y-labels").on("update",c),this.layer("grid-y-labels").on("update:transition",d),this.layer("grid-y-labels").on("exit:transition",e)},addLastTrade:function(a){this.addLastTradeLine(a),this.addLastTradeSlab(a),this.addLastTradeLabel(a)},addLastTradeLine:function(a){function b(){this.attr("class","last-trade-price").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x1",0).attr("x2",a.width()-a.margin.right).attr("y1",function(b){return a.y(Number(b.close))}).attr("y2",function(b){return a.y(Number(b.close))})}function c(){this.classed("fall",function(a){return Number(a.open)>Number(a.close)})}function d(){this.duration(1e3).attr("y1",function(b){return a.y(Number(b.close))}).attr("y2",function(b){return a.y(Number(b.close))})}function e(){this.remove()}function f(a){return this.selectAll("line.last-trade-price").data([a[a.length-1]],function(a){return a.open_time})}function g(){return this.insert("line")}this.layer("last-trade",this.base.append("g").attr("class","last-trade"),{dataBind:f,insert:g}),this.layer("last-trade").on("enter",b),this.layer("last-trade").on("update",c),this.layer("last-trade").on("update:transition",d),this.layer("last-trade").on("exit:transition",e)},addLastTradeSlab:function(a){function b(){this.attr("class","last-trade-slab").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x",a.width()-a.margin.right+i).attr("y",function(b){return a.y(Number(b.close))-k}).attr("rx",3).attr("ry",3).attr("width",h).attr("height",j)}function c(){this.classed("fall",function(a){return Number(a.open)>Number(a.close)})}function d(){this.duration(1e3).attr("y",function(b){return a.y(Number(b.close))-k})}function e(){this.remove()}function f(a){return this.selectAll("rect.last-trade-slab").data([a[a.length-1]],function(a){return a.open_time})}function g(){return this.insert("rect")}var h=48,i=.25*h,j=19,k=j/2-1;this.layer("last-trade-slab",this.base.append("g").attr("class","last-trade-slab"),{dataBind:f,insert:g}),this.layer("last-trade-slab").on("enter",b),this.layer("last-trade-slab").on("update",c),this.layer("last-trade-slab").on("update:transition",d),this.layer("last-trade-slab").on("exit:transition",e)},addLastTradeLabel:function(a){function b(){this.attr("class","last-trade-label").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x",a.width()-a.margin.right).attr("y",function(b){return a.y(Number(b.close))}).attr("dy",5).attr("dx",20).attr("text-anchor","left").text(function(a){return String(Number(a.close).toFixed(1))})}function c(){this.classed("fall",function(a){return Number(a.open)>Number(a.close)}).text(function(a){return String(Number(a.close).toFixed(1))})}function d(){this.duration(1e3).attr("y",function(b){return a.y(Number(b.close))})}function e(){this.remove()}function f(a){return this.selectAll("text.last-trade-label").data([a[a.length-1]],function(a){return a.open_time})}function g(){return this.insert("text")}this.layer("last-trade-label",this.base.append("g").attr("class","last-trade-label"),{dataBind:f,insert:g}),this.layer("last-trade-label").on("enter",b),this.layer("last-trade-label").on("update",c),this.layer("last-trade-label").on("update:transition",d),this.layer("last-trade-label").on("exit:transition",e)},addWicks:function(a){function b(){var b=this.data().length;this.attr("class","wick").attr("x1",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("x2",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("y1",function(b){return a.y(Number(b.high))}).attr("y2",function(b){return a.y(Number(b.low))}).attr("width",1)}function c(){var b=this[0].length;this.duration(1e3).attr("x1",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("x2",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("y1",function(b){return a.y(Number(b.high))}).attr("y2",function(b){return a.y(Number(b.low))})}function d(){var b=this[0].length;this.duration(1e3).attr("x1",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("x2",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("y1",function(b){return a.y(Number(b.high))}).attr("y2",function(b){return a.y(Number(b.low))})}function e(){var b=this[0].length;this.duration(1e3).attr("x1",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("x2",function(c){return a.x(a.timestamp(c.open_time))+a.widthForCandle(b)/2}).attr("y1",function(b){return a.y(Number(b.high))}).attr("y2",function(b){return a.y(Number(b.low))}).remove()}function f(a){return this.selectAll("line.wick").data(a,function(a){return a.open_time})}function g(){return this.insert("line")}this.layer("wicks",this.base.append("g").attr("class","wicks"),{dataBind:f,insert:g}),this.layer("wicks").on("enter",b),this.layer("wicks").on("enter:transition",c),this.layer("wicks").on("update:transition",d),this.layer("wicks").on("exit:transition",e)},addLines:function(a,b){"undefined"!=typeof b&&b.length>0&&b.forEach(function(b){a.addLine(b,a)})},addLine:function(a,b){function c(){var b,c;this.attr("class",a).attr("d",function(a){return b?(c=b,b=a,i([c,a])):(b=a,void 0)})}function d(){var a,b;this.duration(1e3).attr("d",function(c){return a?(b=a,a=c,i([b,c])):(a=c,void 0)})}function e(){var a,b;this.duration(1e3).attr("d",function(c){return a?(b=a,a=c,i([b,c])):(a=c,void 0)})}function f(){var a,b;this.duration(1e3).attr("d",function(c){return a?(b=a,a=c,i([b,c])):(a=c,void 0)}).remove()}function g(b){var c=[];return b.forEach(function(b){b[a]&&c.push(b)}),this.selectAll("path."+a).data(c,function(a){return a.open_time})}function h(){return this.insert("path")}var i=d3.svg.line().x(function(a){return b.x(b.timestamp(a.open_time))}).y(function(c){return c[a]?b.y(c[a]):b.y(0)});this.layer(a,b.base.append("g").attr("class",a),{dataBind:g,insert:h}),this.layer(a).on("enter",c),this.layer(a).on("enter:transition",d),this.layer(a).on("update:transition",e),this.layer(a).on("exit:transition",f)},addOpenLines:function(a){function b(){var b=this.data().length;this.attr("class","open-line").attr("x",function(b){return a.x(a.timestamp(b.open_time))}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("width",function(){return a.widthForCandle(b)}).attr("height",1)}function c(a){return this.selectAll("rect.open-line").data(a,function(a){return a.open_time})}function d(){return this.insert("rect")}function e(){this[0].length,this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5})}function f(){var b=this[0].length;this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("width",function(){return a.widthForCandle(b)})}function g(){this.remove()}this.layer("open-lines",this.base.append("g").attr("class","open-lines"),{dataBind:c,insert:d}),this.layer("open-lines").on("enter",b),this.layer("open-lines").on("enter:transition",e),this.layer("open-lines").on("update:transition",f),this.layer("open-lines").on("exit:transition",g)},addBars:function(){},getBarData:function(){},addInfo:function(a){this.layer("info",this.base.append("g").attr("class","info"),{dataBind:function(){return this.selectAll("rect").data([])},insert:function(){return this.insert("text")}});var b=d3.bisector(function(a){return new Date(a.open_time).getTime()/1e3}).left,c=function(){var b=200,c=115,d=15,e=6;a.layer("info").append("line").attr("class","info line-x").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0),a.layer("info").append("line").attr("class","info line-y").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0),a.layer("info").append("rect").attr("class","info").attr("width",b).attr("height",c).attr("x",0).attr("y",0);var f=a.layer("info").append("text").attr("class","info").attr("y",e).attr("x",e).attr("width",b-2*e).attr("height",c-2*e),g=d;f.append("tspan").attr("x",e).attr("y",g).text(a.exchange).attr("class","title"),g+=d;var h="";f.append("tspan").attr("x",e).attr("y",g).attr("class","date").text(h.toLocaleString()),g+=d,[["Open",""],["High",""],["Low",""],["Close",""],["Vol",""]].forEach(function(a){f.append("tspan").attr("class","titled-title "+a[0].toLowerCase()).attr("x",e).attr("y",g).text(a[0]+":"),f.append("tspan").attr("class","titled-data "+a[0].toLowerCase()).attr("dx",0).text(" "+a[1]),g+=d}),a.layer("info").style("display","none")};c(),this.base.on("mousemove",function(){a.layer("info").style("display","block");var c=d3.mouse(this)[0],d=d3.mouse(this)[1],e=a.x.invert(c),f=a.getBarData(a),g=b(f,e,1),h=f[g];if(a.layer("info").select("line.line-x").attr("x2",a.width()).attr("y1",d).attr("y2",d),a.layer("info").select("line.line-y").attr("x1",c).attr("x2",c).attr("y2",a.height()),h){var i=new Date(h.open_time);a.layer("info").select("tspan.date").text(i.toLocaleString()),[["Open",h.open],["High",h.high],["Low",h.low],["Close",h.close],["Vol",h.volume]].forEach(function(b){a.layer("info").select("tspan.titled-title."+b[0].toLowerCase()).text(b[0]+":"),a.layer("info").select("tspan.titled-data."+b[0].toLowerCase()).text(" "+b[1])})}}),this.base.on("mouseout",function(){var b,c,d=a.base[0][0].getBBox(),e=d3.mouse(this)[0],f=d3.mouse(this)[1];b="undefined"!=typeof event?event.x:e,c="undefined"!=typeof event?event.y:f;var g=b<d.x||b>d.x+d.width,h=c<d.y||c>d.y+d.height;(h||g)&&a.layer("info").style("display","none")})}}),d3.chart("BaseCandlestickChart").extend("CandlestickChart",{addBars:function(a){function b(){var b=this.data().length;this.attr("class","candle").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x",function(b){return a.x(a.timestamp(b.open_time))}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("width",function(){return a.widthForCandle(b)}).attr("height",function(b){return a.heightForCandle(a.y,b)}).attr("stroke-width",a.strokeWidth)}function c(){this[0].length,this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5})}function d(){this.classed("fall",function(a){return Number(a.open)>Number(a.close)})}function e(){this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("height",function(b){return a.heightForCandle(a.y,b)})}function f(){this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5}).remove()}function g(a){return this.selectAll("rect.candle").data(a,function(a){return a.open_time})}function h(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:g,insert:h}),this.layer("bars").on("enter",b),this.layer("bars").on("update",d),this.layer("bars").on("enter:transition",c),this.layer("bars").on("update:transition",e),this.layer("bars").on("exit:transition",f)},getBarData:function(a){return a.layer("bars").selectAll("rect.candle").data()}}),d3.chart("BaseCandlestickChart").extend("OHLCChart",{addBars:function(a){function b(b,c){return Number(b.open)>Number(b.close)?a.x(a.timestamp(b.open_time))+c:a.x(a.timestamp(b.open_time))}function c(){var c=this.data().length,d=a.widthForCandle(c)/2;this.attr("class","ohlc").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x",function(a){return b(a,d)}).attr("y",function(b){var c=a.heightForCandle(a.y,b);return a.y(a.getStartingY(b))-a.strokeWidth+c}).attr("width",d).attr("height",1)}function d(){var c=this[0].length,d=a.widthForCandle(c)/2;this.duration(1e3).attr("x",function(a){return b(a,d)})}function e(){this.classed("fall",function(a){return Number(a.open)>Number(a.close)})}function f(){var c=this[0].length,d=a.widthForCandle(c)/2;this.duration(1e3).attr("x",function(a){return b(a,d)}).attr("y",function(b){var c=a.heightForCandle(a.y,b);return a.y(a.getStartingY(b))-a.strokeWidth+c})}function g(){var b=this[0].length,c=a.widthForCandle(b)/2;this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))+c}).remove()}function h(a){return this.selectAll("rect.ohlc").data(a,function(a){return a.open_time})}function i(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:h,insert:i}),this.layer("bars").on("enter",c),this.layer("bars").on("update",e),this.layer("bars").on("enter:transition",d),this.layer("bars").on("update:transition",f),this.layer("bars").on("exit:transition",g)},getBarData:function(a){return a.layer("bars").selectAll("rect.ohlc").data()},addOpenLines:function(a){function b(b,c){return Number(b.open)>Number(b.close)?a.x(a.timestamp(b.open_time)):a.x(a.timestamp(b.open_time))+c}function c(){var c=this.data().length,d=a.widthForCandle(c)/2;this.attr("class","open-line").attr("x",function(a){return b(a,d)}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("width",d).attr("height",1)}function d(a){return this.selectAll("rect.open-line").data(a,function(a){return a.open_time})}function e(){return this.insert("rect")}function f(){var c=this[0].length,d=a.widthForCandle(c)/2;this.duration(1e3).attr("x",function(a){return b(a,d)})}function g(){var c=this[0].length,d=a.widthForCandle(c)/2;this.duration(1e3).attr("x",function(a){return b(a,d)}).attr("y",function(b){return a.y(a.getStartingY(b))-a.strokeWidth}).attr("width",function(){return d})}function h(){this.remove()}this.layer("open-lines",this.base.append("g").attr("class","open-lines"),{dataBind:d,insert:e}),this.layer("open-lines").on("enter",c),this.layer("open-lines").on("enter:transition",f),this.layer("open-lines").on("update:transition",g),this.layer("open-lines").on("exit:transition",h)}}),d3.chart("VolumeChart",{timestamp:function(a){return new Date(a).getTime()/1e3},widthForBar:function(a){return(this.width()-this.margin.right)/a-2*this.strokeWidth-this.candleMargin},heightForBar:function(a,b){var c=a(b.volume);return c},initialize:function(a){a=a||{};var b=this;this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.base.attr("class","volume chart"),this.addBars(b),this.width(a.width||900),this.height(a.height||100),this.strokeWidth=a.strokeWidth||1,this.candleMargin=1,this.margin={top:0,bottom:0,left:0,right:60}},width:function(a){return arguments.length?(this.w=a,this.x.range([0,this.w]),this.base.attr("width",this.w),this):this.w},height:function(a){return arguments.length?(this.h=a,this.y.rangeRound([0,this.h]),this.base.attr("height",this.h),this):this.h},transform:function(a){a=a.data;var b=d3.min(a.map(function(a){return new Date(a.open_time).getTime()/1e3})),c=d3.max(a.map(function(a){return new Date(a.open_time).getTime()/1e3}));d3.min(a.map(function(a){return Number(a.volume)}));var d=d3.max(a.map(function(a){return Number(a.volume)}));return this.x.domain([b,c]).range([0,this.width()-this.margin.right]),this.y.domain([0,d]).range([0,this.height()]),a},addBars:function(a){function b(){var b=this.data().length;this.attr("class","volume").classed("fall",function(a){return Number(a.open)>Number(a.close)}).attr("x",function(b){return a.x(a.timestamp(b.open_time))}).attr("y",function(b){return a.height()-a.heightForBar(a.y,b)}).attr("width",function(){return a.widthForBar(b)}).attr("height",function(b){return a.heightForBar(a.y,b)}).attr("fill","white")}function c(){this[0].length,this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5})}function d(){this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5}).attr("y",function(b){return a.height()-a.heightForBar(a.y,b)}).attr("height",function(b){return a.heightForBar(a.y,b)})}function e(){this.duration(1e3).attr("x",function(b){return a.x(a.timestamp(b.open_time))-.5}).remove()}function f(a){return this.selectAll("rect.volume").data(a,function(a){return a.open_time})}function g(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:f,insert:g}),this.layer("bars").on("enter",b),this.layer("bars").on("enter:transition",c),this.layer("bars").on("update:transition",d),this.layer("bars").on("exit:transition",e)}});